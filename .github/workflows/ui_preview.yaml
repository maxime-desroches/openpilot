name: "ui preview"
on:
  pull_request_target:
    types:
      - opened
    branches:
      - 'master'
    paths:
      - 'selfdrive/ui/**'

jobs:
  preview:
    name: preview
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    #- name: Installing ubuntu dependencies
    #  run: INSTALL_EXTRA_PACKAGES=no tools/install_ubuntu_dependencies.sh
    #- name: Installing python dependencies
     # run: tools/install_python_dependencies.sh  
    - name: git LFS
      run: git lfs pull
    - run: echo "CACHE_COMMIT_DATE=$(git log -1 --pretty='format:%cd' --date=format:'%Y-%m-%d-%H:%M')" >> $GITHUB_ENV
    - name: Getting scons cache
      uses: 'actions/cache@v4'
      with:
        path: /tmp/scons_cache
        key: scons-${{ runner.arch }}-${{ env.CACHE_COMMIT_DATE }}-${{ github.sha }}
        restore-keys: |
          scons-${{ runner.arch }}-${{ env.CACHE_COMMIT_DATE }}
          scons-${{ runner.arch }}
          
  #  - name: Getting screenshots
   #   run: |
     #   . .venv/bin/activate
      #  scons -u -j$(nproc)
     #   export PYTHONWARNINGS=ignore
     #   source selfdrive/test/setup_xvfb.sh
     #   python3 selfdrive/ui/tests/test_ui/run.py

    - name: Checkout ci-artifacts
      uses: actions/checkout@v4
      with:
        repository: maxime-desroches/ci-artifacts
        #ssh-key: ${{ secrets.CI_ARTIFACTS_DEPLOY_KEY }}
        path: ${{ github.workspace }}/ci-artifacts
        ref: master

    - name: Push Screenshots
      working-directory: ${{ github.workspace }}/ci-artifacts
      run: |
        echo 'cool' > cool
        git checkout -b openpilot/pr-${{ github.event.number }}
        git config user.name "GitHub Actions Bot"
        git config user.email "<>"
        git add ${{ github.workspace }}/ci-artifacts/cool
        git commit -m "screenshots for PR #${{ github.event.number }}"
        git push origin openpilot/pr-${{ github.event.number }} --force

    - name: Comment Screenshots on PR
      uses: thollander/actions-comment-pull-request@v2
      with:
        message: |
          <!-- _(run_id_screenshots **${{ github.run_id }}**)_ -->
          ## UI Screenshots
          <table>
            <tr>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/homescreen.png"></td>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/onroad.png"></td>
            </tr>
            <tr>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/onroad_map.png"></td>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/onroad_sidebar.png"></td>
            </tr>
            <tr>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/settings_network.png"></td>
              <td><img src="https://raw.githubusercontent.com/commaai/ci-artifacts/openpilot/pr-${{ github.event.number }}/report-${{ github.event.number }}/screenshots/settings_device.png"></td>
            </tr>
          </table>
        pr_number: ${{ github.event.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
